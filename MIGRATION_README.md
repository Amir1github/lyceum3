# Миграция с JSON файлов на Supabase

Этот документ содержит инструкции по миграции вашего веб-сайта лицея с файловой системы JSON на базу данных Supabase.

## Обзор изменений

### Что было изменено:
- ✅ Создана схема базы данных Supabase (`supabase_schema.sql`)
- ✅ Создан скрипт миграции данных (`migrate_to_supabase.js`)
- ✅ Создан клиент Supabase (`lib/supabase.js`)
- ✅ Обновлены все API endpoints для работы с Supabase
- ✅ Добавлена команда миграции в `package.json`

### API endpoints, которые были обновлены:
- `/api/news` - Новости
- `/api/gallery` - Галерея изображений
- `/api/cabinets` - Кабинеты и преподаватели
- `/api/messages` - Сообщения от пользователей
- `/api/vacancies` - Вакансии
- `/api/contactinfo` - Контактная информация
- `/api/classlist` - Список классов
- `/api/students` - Данные студентов
- `/api/workhour` - Рабочие часы
- `/api/sendmessage` - Отправка сообщений

## Пошаговая инструкция по миграции

### Шаг 1: Настройка переменных окружения

Создайте файл `.env.local` в корне проекта:

```bash
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=https://zsvdqzefetzfdfaqgunb.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzdmRxemVmZXR6ZmRmYXFndW5iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3OTk3NDksImV4cCI6MjA3NDM3NTc0OX0.3AJ6iMJmhKLDGhN7BMPDrXGCtJ_nFMGw8b3pZ1eZz4M

# Cloudinary Configuration (сохраните существующие настройки)
NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME=dzbuo2vqt
CLOUDINARY_API_KEY=612574697429781
CLOUDINARY_API_SECRET=Aj_5ed6q99dvzlpjeLI-nsDBsh0
```

### Шаг 2: Создание схемы базы данных

1. Откройте Supabase Dashboard: https://supabase.com/dashboard
2. Выберите ваш проект
3. Перейдите в раздел "SQL Editor"
4. Скопируйте содержимое файла `supabase_schema.sql` и выполните его

### Шаг 3: Установка зависимостей

Убедитесь, что у вас установлена последняя версия Supabase клиента:

```bash
npm install @supabase/supabase-js@latest
```

### Шаг 4: Запуск миграции данных

Выполните команду миграции:

```bash
npm run migrate
```

Или запустите скрипт напрямую:

```bash
node migrate_to_supabase.mjs
```

### Шаг 4.1: Миграция недостающих таблиц (если нужно)

Если некоторые таблицы не заполнились, запустите дополнительную миграцию:

```bash
npm run migrate-missing
```

Или:

```bash
node migrate_missing_tables.mjs
```

Этот скрипт мигрирует следующие таблицы:
- messages (сообщения)
- work_hours (рабочие часы) 
- students (студенты)
- vacancies (вакансии)
- class_groups и classes (группы классов и классы)
- cabinets, staff, cabinet_types, pavilions (кабинеты и преподаватели)

### Шаг 5: Проверка миграции

После успешной миграции проверьте данные в Supabase Dashboard:
1. Перейдите в раздел "Table Editor"
2. Убедитесь, что все таблицы созданы и содержат данные
3. Проверьте основные таблицы: `news`, `gallery`, `messages`, `vacancies`, etc.

### Шаг 6: Тестирование API

Запустите приложение в режиме разработки:

```bash
npm run dev
```

Протестируйте основные функции:
- Просмотр новостей
- Загрузка изображений в галерею
- Отправка сообщений
- Просмотр вакансий
- Поиск кабинетов по преподавателю

## Структура базы данных

### Основные таблицы:

1. **gallery** - Изображения галереи
2. **class_groups** - Группы классов (1-4, 5-9, 10-11)
3. **classes** - Классы с буквами
4. **staff** - Преподаватели
5. **cabinets** - Кабинеты
6. **cabinet_types** - Типы кабинетов
7. **pavilions** - Павильоны
8. **contact_info** - Контактная информация
9. **news** - Новости
10. **students** - Данные студентов (в JSONB)
11. **vacancies** - Вакансии
12. **messages** - Сообщения
13. **work_hours** - Рабочие часы

### Связи между таблицами:
- `classes` → `class_groups` (многие к одному)
- `cabinets` → `staff` (один к одному)
- `cabinets` → `cabinet_types` (многие к одному)
- `cabinets` → `pavilions` (многие к одному)

## Безопасность

### Row Level Security (RLS)
Все таблицы защищены политиками RLS:
- **Публичный доступ**: Только для чтения данных
- **Административный доступ**: Полные права (требует настройки аутентификации)

### Рекомендации по безопасности:
1. Настройте аутентификацию администраторов
2. Создайте отдельные политики для админских операций
3. Используйте сервисные ключи для серверных операций
4. Настройте CORS политики

## Возможные проблемы и решения

### Ошибка подключения к Supabase
```
Error: Invalid API key
```
**Решение**: Проверьте правильность URL и ключа в `.env.local`

### Ошибка миграции
```
Error: relation "table_name" does not exist
```
**Решение**: Убедитесь, что схема базы данных создана корректно

### Ошибка CORS
**Решение**: Настройте CORS в Supabase Dashboard → Settings → API

### Медленная работа API
**Решение**: 
1. Добавьте индексы для часто используемых полей
2. Оптимизируйте запросы
3. Используйте кэширование

## Откат изменений

Если необходимо вернуться к файловой системе:

1. Восстановите оригинальные API endpoints из git
2. Убедитесь, что JSON файлы в папке `public/data` не повреждены
3. Удалите файлы миграции и Supabase конфигурацию

## Поддержка

После миграции ваше приложение будет:
- ✅ Быстрее работать с данными
- ✅ Более надежно хранить информацию
- ✅ Легче масштабироваться
- ✅ Иметь лучшую производительность

## Дополнительные возможности

После успешной миграции вы можете:
1. Добавить аутентификацию пользователей
2. Настроить реальное время с помощью Supabase Realtime
3. Добавить резервное копирование
4. Настроить мониторинг производительности

---

**Важно**: Обязательно создайте резервную копию JSON файлов перед началом миграции!
